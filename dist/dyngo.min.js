/*   Copyright 2015 Nortal AS
 *
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 */
angular.module("dyngo",["dyngo.core","dyngo.components"]),angular.module("dyngo.components.default",["dyngo.components.provider"]).run(["componentProvider",function(n){n.registerComponent("textInput",{group:"Default",label:"Text Input",templateUrl:"templates/text.html"}),n.registerComponent("numberInput",{group:"Default",label:"Text Input",templateUrl:"templates/number.html"}),n.registerComponent("checkbox",{group:"Default",label:"Checkbox",templateUrl:"templates/checkbox.html"}),n.registerComponent("radio",{group:"Default",label:"Radio",templateUrl:"templates/radio.html"}),n.registerComponent("select",{group:"Default",label:"Select",templateUrl:"templates/select.html"}),n.registerComponent("header",{group:"static-controls",templateUrl:"templates/header.html"}),n.registerComponent("panel",{group:"containers",templateUrl:"templates/panel.html"}),n.registerComponent("staticText",{group:"static-controls",templateUrl:"templates/static-text.html"}),n.registerComponent("hidden",{group:"Default",templateUrl:"templates/hidden.html"})}]),angular.module("dyngo.components.provider",[]).provider("componentProvider",function(){this.components={};var n,e,t=function(n,e,t){null==n.template&&e.get(n.templateUrl,{cache:t}).success(function(e){n.template=e})};this.registerComponent=function(o,i){null==i&&(i={}),null==this.components[o]&&(this.components[o]=i,t(i,n,e))},this.$get=["$http","$templateCache",function(o,i){return n=o,e=i,angular.forEach(this.components,function(n){t(n,o,i)}),{components:this.components,registerComponent:this.registerComponent}}]}),angular.module("dyngo.components",["dyngo.components.provider","dyngo.components.default"]);var assignTranslations=function(n,e){angular.forEach(n.components,function(n){n.translations=e,_.isUndefined(n.components)||assignTranslations(n,e)})};angular.module("dyngo.core",["checklist-model","mgcrea.ngStrap.popover","ngSanitize","ngMessages"]).provider("dyngo",function(){var n={forms:{}};return n.registerForm=function(e,t,o){var i={name:e,structure:t,options:o};n.forms.name=i},n.getForm=function(){return n.forms.name},{$get:function(){return n}}}).directive("dgForm",["dyngo",function(n){return{restrict:"A",require:"ngModel",scope:{formName:"@dgForm",formModel:"=dgForm",lang:"@dgLang",data:"=ngModel"},template:'<div dg-container="form.structure" ng-model="data"></div>',link:function(e){if(e.form=n.getForm(e.formName),!_.isUndefined(e.form)){var t=e.form.structure;this.assignTranslations(t,t.translations[e.lang])}}}}]).controller("ContainerController",["$scope",function(n){n.visible=function(t){var o=!0;_.isUndefined(t.parent)||(o=n.visible(t.parent));var i=t.constraints?t.constraints.visible:void 0;return o&&!_.isUndefined(i)&&(o=n.$eval(i,n.data)),o||e(t),o};var e=function(t){delete n.data[t.id],angular.forEach(t.components,function(n){e(n)})}}]).directive("dgContainer",function(){return{restrict:"A",require:"ngModel",scope:{container:"=dgContainer",data:"=ngModel"},template:'<div class="fb-form-object" ng-repeat="component in container.components" dg-component="component" ng-model="data" ng-if="visible(component)"></div>',controller:"ContainerController",link:function(n){n.formModel=n.$parent.formModel}}}).controller("ComponentCtrl",["$scope",function(n){n.visible=function(){return!0}}]).directive("dgComponent",["$compile","$parse","componentProvider","$functions","$log",function(n,e,t,o,i){return{restrict:"A",require:"ngModel",link:function(a,r,s){a.formName=a.$parent.formName,a.formModel=a.$parent.formModel,a.component=e(s.dgComponent)(a);var l=a.component;if(a.$component=t.components[l.type],_.isUndefined(a.$component))return void i.error("Unknown component type:",l.type);var d=n(a.$component.template)(a);r.append(d),a.id=l.id,a.label=l.translations&&l.translations[l.label]||l.label,a.description=l.description,a.placeholder=l.placeholder,a.options=l.options||a.$component.options,a.constraints=l.constraints||a.$component.constraints;var c=function(n,e){if(!_.isUndefined(n.constraints)&&!_.isUndefined(n.constraints[e])){var t=n.$eval(n.constraints[e],n.data);return t=_.isUndefined(t)?n.constraints[e]:t}return null};a.min=function(){return c(a,"min")},a.max=function(){return c(a,"max")},a.components=l.components,_.isUndefined(l.functions)||a.$watch("data",function(){o.executeFunctions(a,a.component,a.data)},!0),a.setData=function(n){_.isUndefined(n)||_.isNull(n)||_.isNaN(n)?a.data[a.id]=void 0:_.isEqual(a.data[a.id],n)||(a.data[a.id]=n)},a.localize=function(n){var e,t=a.component.translations;return _.isUndefined(t)||(e=t[n]),_.isUndefined(e)?n:e.replace(/{{([^}]*)}}/,function(n,e){return a.$eval(e)})}},scope:{data:"=ngModel",component:"=dgComponent"},controller:"ComponentCtrl"}}]).provider("$functions",function(){var n={functions:[]};n.registerFunction=function(e,t){n.functions.push(e),n[e]=t},n.get=function(e){return n[e]||_.noop},n.executeFunctions=function(e,t,o){angular.forEach(n.functions,function(t){_.isUndefined(e[t])&&(e[t]=n[t])}),angular.forEach(t.functions,function(n){e.$eval(n,o)})};var e=function(n,e){var t=Math.pow(10,e||2);return Math.round(n*t)/t};return{$get:function(){return n.registerFunction("round",e),n}}}),function(n){try{n=angular.module("dyngo.components")}catch(e){n=angular.module("dyngo.components",[])}n.run(["$templateCache",function(n){n.put("templates/checkbox.html",'<div class="form-group">\n\n  <label for="{{id+\'_\'+$index}}" class="col-sm-4 control-label"\n         ng-class="{required : constraints.required}">{{label}}</label>\n\n  <div class="col-sm-4">\n    <div class="checkbox" ng-repeat="option in options track by option.code">\n      <label>\n        <input type="checkbox" id="{{id+\'_\'+$index}}" name="{{id}}" checklist-model="data[id]"\n               checklist-value="option.code" value="{{option.code}}" ng-disabled="constraints.disabled"\n               ng-required="constraints.required && (!data[id] || data[id].length == 0)">{{option.text}}\n      </label>\n    </div>\n\n    <div ng-messages="formModel[id].$error" class="message-invalid"\n         ng-if="formModel.submitPressed && constraints.required && (!data[id] || data[id].length == 0)">\n      <div ng-message="required">{{localize("error.no_item_selected")}}</div>\n    </div>\n  </div>\n\n</div>\n')}])}(),function(n){try{n=angular.module("dyngo.components")}catch(e){n=angular.module("dyngo.components",[])}n.run(["$templateCache",function(n){n.put("templates/header.html",'<div class="page-header">\n  <h2>{{label}}</h2>\n</div>')}])}(),function(n){try{n=angular.module("dyngo.components")}catch(e){n=angular.module("dyngo.components",[])}n.run(["$templateCache",function(n){n.put("templates/hidden.html",'<div class="form-group">\n\n  <div class="col-sm-4"></div>\n\n  <div class="col-sm-4">\n    <input type="hidden" ng-model="data[id]">\n  </div>\n\n</div>')}])}(),function(n){try{n=angular.module("dyngo.components")}catch(e){n=angular.module("dyngo.components",[])}n.run(["$templateCache",function(n){n.put("templates/number.html",'<div class="form-group">\n  <label for="{{id}}" class="col-sm-4 control-label"\n         ng-class="{required : constraints.required}">{{label}}</label>\n\n  <div class="col-sm-4" ng-switch on="description !== undefined">\n\n    <div class="input-group" ng-switch-when="true">\n\n      <input type="number" id="{{id}}" name="{{id}}" ng-model="data[id]" class="form-control"\n             placeholder="{{placeholder}}"\n             min="{{min()}}" max="{{max()}}"\n             ng-disabled="constraints.disabled" ng-required="constraints.required"/>\n       <span class="input-group-btn">\n         <button type="button" class="btn btn-default"\n                 data-placement="right" title="{{description.title}}" data-content="{{description.content}}"\n                 data-trigger="click" bs-popover>\n           <span class="glyphicon glyphicon-question-sign"></span>\n         </button>\n      </span>\n    </div>\n\n    <div ng-switch-default>\n      <input type="number" id="{{id}}" name="{{id}}" ng-model="data[id]" class="form-control"\n             placeholder="{{placeholder}}"\n             min="{{min()}}" max="{{max()}}"\n             ng-disabled="constraints.disabled" ng-required="constraints.required"/>\n    </div>\n    <div ng-messages="formModel[id].$error" class="message-invalid" ng-if="formModel.submitPressed">\n      <div ng-message="required">{{localize("error.required_field")}}</div>\n      <div ng-message="max">{{localize("error.value_is_gt_max")}}</div>\n      <div ng-message="min">{{localize("error.value_is_lt_min")}}</div>\n    </div>\n\n  </div>\n\n</div>\n')}])}(),function(n){try{n=angular.module("dyngo.components")}catch(e){n=angular.module("dyngo.components",[])}n.run(["$templateCache",function(n){n.put("templates/panel.html",'<div class="panel panel-default">\n  <div class="panel-heading" ng-if="label">\n    <h3 class="panel-title">{{label}}</h3>\n  </div>\n  <div class="panel-body">\n    <div dg-container="component" ng-model="data" dg-data="data" ng-show="visible(component)"></div>\n  </div>\n</div>')}])}(),function(n){try{n=angular.module("dyngo.components")}catch(e){n=angular.module("dyngo.components",[])}n.run(["$templateCache",function(n){n.put("templates/radio.html",'<div class="form-group">\n\n  <label class="col-sm-4 control-label"\n         ng-class="{required : constraints.required}">{{label}}</label>\n\n  <div class="col-sm-4">\n    <div class="radio" ng-repeat="option in options track by option.code">\n      <label>\n        <input type="radio" name="{{id}}" id="{{id+\'_\'+$index}}" ng-model="data[id]"\n               ng-value="option.code"\n               ng-disabled="constraints.disabled" ng-required="constraints.required">{{localize(option.text)}}\n      </label>\n    </div>\n\n    <div ng-messages="formModel[id].$error" class="message-invalid" ng-if="formModel.submitPressed">\n      <div ng-message="required">{{localize("error.no_item_selected")}}</div>\n    </div>\n  </div>\n\n</div>\n')}])}(),function(n){try{n=angular.module("dyngo.components")}catch(e){n=angular.module("dyngo.components",[])}n.run(["$templateCache",function(n){n.put("templates/select.html",'<div class="form-group">\n\n  <label for="{{id}}" class="col-sm-4 control-label"\n         ng-class="{required : constraints.required}">{{label}}</label>\n\n  <div class="col-sm-4" ng-switch on="description !== undefined">\n\n    <div class="input-group" ng-switch-when="true">\n\n      <select id="{{id}}" name="{{id}}" class="form-control"\n              ng-options="option.code as option.value for option in options"\n              ng-model="data[id]" ng-disabled="constraints.disabled" ng-required="constraints.required">\n        <option></option>\n      </select>\n       <span class="input-group-btn">\n         <button type="button" class="btn btn-default"\n                 data-placement="right" title="{{description.title}}" data-content="{{description.content}}"\n                 data-trigger="click" bs-popover>\n           <span class="glyphicon glyphicon-question-sign"></span>\n         </button>\n      </span>\n    </div>\n\n    <div ng-switch-default>\n      <div class="select">\n        <select id="{{id}}" name="{{id}}" class="form-control"\n                ng-options="option.code as option.value for option in options"\n                ng-model="data[id]" ng-disabled="constraints.disabled" ng-required="constraints.required">\n          <option></option>\n        </select>\n      </div>\n    </div>\n\n    <div ng-messages="formModel[id].$error" class="message-invalid" ng-if="formModel.submitPressed">\n      <div ng-message="required">{{localize("error.no_item_selected")}}</div>\n    </div>\n\n  </div>\n\n\n</div>\n')}])}(),function(n){try{n=angular.module("dyngo.components")}catch(e){n=angular.module("dyngo.components",[])}n.run(["$templateCache",function(n){n.put("templates/static-text.html",'<div class="form-group">\n  <p ng-bind-html="label"></p>\n</div>\n')}])}(),function(n){try{n=angular.module("dyngo.components")}catch(e){n=angular.module("dyngo.components",[])}n.run(["$templateCache",function(n){n.put("templates/text.html",'<div class="form-group">\n  <label for="{{id}}" class="col-sm-4 control-label"\n         ng-class="{required : constraints.required}">{{label}}</label>\n\n  <div class="col-sm-4" ng-switch on="description !== undefined">\n\n    <div class="input-group" ng-switch-when="true">\n\n      <input type="text" id="{{id}}" name="{{id}}" ng-model="data[id]" class="form-control"\n             placeholder="{{placeholder}}"\n             ng-minlength="constraints.min" ng-maxlength="constraints.max" ng-disabled="constraints.disabled"\n             ng-required="constraints.required"/>\n       <span class="input-group-btn">\n         <button type="button" class="btn btn-default"\n                 data-placement="right" title="{{description.title}}" data-content="{{description.content}}"\n                 data-trigger="click" bs-popover>\n           <span class="glyphicon glyphicon-question-sign"></span>\n         </button>\n      </span>\n    </div>\n\n    <div ng-switch-default>\n      <input type="text" id="{{id}}" name="{{id}}" ng-model="data[id]" class="form-control"\n             placeholder="{{placeholder}}"\n             ng-minlength="constraints.min" ng-maxlength="constraints.max" ng-disabled="constraints.disabled"\n             ng-required="constraints.required"/>\n    </div>\n\n    <div ng-messages="formModel[id].$error" class="message-invalid" ng-if="formModel.submitPressed">\n      <div ng-message="required">{{localize("error.required_field")}}</div>\n    </div>\n  </div>\n\n</div>\n')}])}();