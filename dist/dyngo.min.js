/*   Copyright 2015 Nortal AS
 *
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 */
angular.module("dyngo",["dyngo.core","dyngo.components"]),angular.module("dyngo.components.default",["dyngo.components.provider"]).run(["componentProvider",function(n){n.registerComponent("textInput",{group:"Default",label:"Text Input",templateUrl:"templates/text.html"}),n.registerComponent("numberInput",{group:"Default",label:"Text Input",templateUrl:"templates/number.html"}),n.registerComponent("checkbox",{group:"Default",label:"Checkbox",templateUrl:"templates/checkbox.html"}),n.registerComponent("radio",{group:"Default",label:"Radio",templateUrl:"templates/radio.html"}),n.registerComponent("select",{group:"Default",label:"Select",templateUrl:"templates/select.html"}),n.registerComponent("header",{group:"static-controls",templateUrl:"templates/header.html"}),n.registerComponent("panel",{group:"containers",templateUrl:"templates/panel.html"}),n.registerComponent("staticText",{group:"static-controls",templateUrl:"templates/static-text.html"}),n.registerComponent("hidden",{group:"Default",templateUrl:"templates/hidden.html"})}]),angular.module("dyngo.components.provider",[]).provider("componentProvider",function(){this.components={};var n,e,t=function(n,e,t){null==n.template&&e.get(n.templateUrl,{cache:t}).success(function(e){n.template=e})};this.registerComponent=function(o,r){null==r&&(r={}),null==this.components[o]&&(this.components[o]=r,t(r,n,e))},this.$get=["$http","$templateCache",function(o,r){return n=o,e=r,angular.forEach(this.components,function(n){t(n,o,r)}),{components:this.components,registerComponent:this.registerComponent}}]}),angular.module("dyngo.components",["dyngo.components.provider","dyngo.components.default"]);var assignTranslations=function(n,e){angular.forEach(n.components,function(n){n.translations=e,_.isUndefined(n.components)||assignTranslations(n,e)})};angular.module("dyngo.core",["checklist-model","mgcrea.ngStrap.popover","ngSanitize","ngMessages"]).provider("dyngo",function(){var n={forms:{}};return n.registerForm=function(e,t,o){var r={name:e,structure:t,options:o};n.forms.name=r},n.getForm=function(){return n.forms.name},{$get:function(){return n}}}).directive("dgForm",["dyngo",function(n){return{restrict:"A",require:"ngModel",scope:{formName:"@dgForm",formModel:"=dgForm",lang:"@dgLang",data:"=ngModel"},template:'<div dg-container="form.structure" ng-model="data"></div>',link:function(e){if(e.form=n.getForm(e.formName),!_.isUndefined(e.form)){var t=e.form.structure;this.assignTranslations(t,t.translations[e.lang])}}}}]).controller("ContainerController",["$scope",function(n){n.visible=function(t){var o=!0;_.isUndefined(t.parent)||(o=n.visible(t.parent));var r=t.constraints?t.constraints.visible:void 0;return o&&!_.isUndefined(r)&&(o=n.$eval(r,n.data)),o||e(t),o};var e=function(t){delete n.data[t.id],angular.forEach(t.components,function(n){e(n)})}}]).directive("dgContainer",function(){return{restrict:"A",require:"ngModel",scope:{container:"=dgContainer",data:"=ngModel"},template:'<div class="fb-form-object" ng-repeat="component in container.components" dg-component="component" ng-model="data" ng-if="visible(component)"></div>',controller:"ContainerController",link:function(n){n.formModel=n.$parent.formModel}}}).controller("ComponentCtrl",["$scope",function(n){n.visible=function(){return!0}}]).directive("dgComponent",["$compile","$parse","componentProvider","$functions","$log",function(n,e,t,o,r){return{restrict:"A",require:"ngModel",link:function(i,a,s){i.formName=i.$parent.formName,i.formModel=i.$parent.formModel,i.component=e(s.dgComponent)(i);var l=i.component;if(i.$component=t.components[l.type],_.isUndefined(i.$component))return void r.error("Unknown component type:",l.type);var c=n(i.$component.template)(i);a.append(c),i.id=l.id,i.label=l.translations&&l.translations[l.label]||l.label,i.description=l.description,i.placeholder=l.placeholder,i.options=l.options||i.$component.options,i.constraints=l.constraints||i.$component.constraints;var m=function(n,e){if(!_.isUndefined(n.constraints)&&!_.isUndefined(n.constraints[e])){var t=n.$eval(n.constraints[e],n.data);return t=_.isUndefined(t)?n.constraints[e]:t}return null};i.min=function(){return m(i,"min")},i.max=function(){return m(i,"max")},i.components=l.components,_.isUndefined(l.functions)||i.$watch("data",function(){o.executeFunctions(i,i.component,i.data)},!0),i.setData=function(n){_.isUndefined(n)||_.isNull(n)||_.isNaN(n)?i.data[i.id]=void 0:_.isEqual(i.data[i.id],n)||(i.data[i.id]=n)},i.localize=function(n){var e,t=i.component.translations;return _.isUndefined(t)||(e=t[n]),_.isUndefined(e)?n:e.replace(/{{([^}]*)}}/,function(n,e){return i.$eval(e)})}},scope:{data:"=ngModel",component:"=dgComponent"},controller:"ComponentCtrl"}}]).provider("$functions",function(){var n={functions:[]};n.registerFunction=function(e,t){n.functions.push(e),n[e]=t},n.get=function(e){return n[e]||_.noop},n.executeFunctions=function(e,t,o){angular.forEach(n.functions,function(t){_.isUndefined(e[t])&&(e[t]=n[t])}),angular.forEach(t.functions,function(n){e.$eval(n,o)})};var e=function(n,e){var t=Math.pow(10,e||2);return Math.round(n*t)/t};return{$get:function(){return n.registerFunction("round",e),n}}});